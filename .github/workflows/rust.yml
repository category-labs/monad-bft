name: Rust

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: ubuntu-latest-32

    steps:
      - uses: actions/checkout@v3
      - run: rustup toolchain install nightly-2023-11-29 --profile minimal --component rustfmt
      - name: Format
        run: cargo +nightly-2023-11-29 fmt --all --check
      - run: cargo install cargo-udeps --locked
      - name: Lint unused deps
        run: cargo +nightly-2023-11-29 udeps --all-targets --all-features
      - uses: Swatinem/rust-cache@v2
      - name: Lint
        run: cargo clippy --all-targets --all-features --
          -D clippy::suspicious
          -D clippy::style
          -D clippy::clone_on_copy
          -D clippy::redundant_clone
          -D clippy::iter_kv_map
          -D clippy::iter_nth
          -D clippy::unnecessary_cast
          -D clippy::filter_next
          -D clippy::needless_lifetimes
          -D clippy::useless_conversion
          -D clippy::useless_vec
          -D clippy::needless_question_mark
          -D clippy::bool_comparison
          -D unused_imports
          -D unused_parens
          -A clippy::type_complexity
          -A clippy::int_plus_one
          -A clippy::uninlined-format-args
          -A clippy::enum-variant-names
          -A clippy::mutable_key_type
      - name: Check
        run: cargo check --all-targets --all-features
      - name: Run tests
        run: cargo test --release --all-targets --all-features
      - name: Run doc tests
        run: cargo test --release --doc --all-features
      - run: rustup target add wasm32-unknown-unknown
      - name: Check WASM
        run: cargo check --target wasm32-unknown-unknown -p monad-debugger
